#cloud-config

# set locale
locale: en_US.UTF-8

# set timezone
timezone: America/Denver

# Set FQDN
fqdn: ${fqdn}

# set root password
chpasswd:
  list: |
    root:linux
    ${username}:${password}
  expire: False

ssh_authorized_keys:
${authorized_keys}

# need to disable gpg checks because the cloud image has an untrusted repo
zypper:
  repos:
${repositories}
  config:
    gpgcheck: "off"
    solver.onlyRequires: "true"
    download.use_deltarpm: "true"

# need to remove the standard docker packages that are pre-installed on the
# cloud image because they conflict with the kubic- ones that are pulled by
# the kubernetes packages
#packages:
#${packages}

write_files:
  - path: /home/sles/.all_nodes
    permissions: "0644"
    content: |
      caasp-master-0.caasp-susecon.lab
      caasp-worker-0.caasp-susecon.lab
      caasp-worker-1.caasp-susecon.lab
  - path: /home/sles/.ssh/config
    encoding: b64
    permissions: "0644"
    content: SE9TVCBjYWFzcC1sYi5jYWFzcC1zdXNlY29uLmxhYiBjYWFzcC1sYiBsYgogIEhPU1ROQU1FIGNhYXNwLWxiLmNhYXNwLXN1c2Vjb24ubGFiCkhPU1QgY2Fhc3AtbWFzdGVyLTAuY2Fhc3Atc3VzZWNvbi5sYWIgY2Fhc3AtbWFzdGVyLTAgbWFzdGVyLTAKICBIT1NUTkFNRSBjYWFzcC1tYXN0ZXItMC5jYWFzcC1zdXNlY29uLmxhYgpIT1NUIGNhYXNwLXdvcmtlci0wLmNhYXNwLXN1c2Vjb24ubGFiIGNhYXNwLXdvcmtlci0wIHdvcmtlci0wCiAgSE9TVE5BTUUgY2Fhc3Atd29ya2VyLTAuY2Fhc3Atc3VzZWNvbi5sYWIKSE9TVCBjYWFzcC13b3JrZXItMS5jYWFzcC1zdXNlY29uLmxhYiBjYWFzcC13b3JrZXItMSB3b3JrZXItMQogIEhPU1ROQU1FIGNhYXNwLXdvcmtlci0xLmNhYXNwLXN1c2Vjb24ubGFiIAoK
  - path: /home/sles/.ssh/id_rsa
    encoding: b64
    permissions: "0600"
    content: LS0tLS1CRUdJTiBPUEVOU1NIIFBSSVZBVEUgS0VZLS0tLS0KYjNCbGJuTnphQzFyWlhrdGRqRUFBQUFBQkc1dmJtVUFBQUFFYm05dVpRQUFBQUFBQUFBQkFBQUJGd0FBQUFkemMyZ3RjbgpOaEFBQUFBd0VBQVFBQUFRRUExSzIwUlBFQVIwaDc3Y3ZHT0lQNGhiM2xKU0IweXVPZmREV0RlTGNRZ2JMcWU4UkhuWjgzCkJpRWduMnlOaTNMOEJrYlpuZzU0U2R3c2dPSTlnUE41M2xqU3FMUSswcUdMV0VNeXovVVpneG4wUzlmcFN4M213RHIwN2UKQ2NSdGNTL0dzdVVIYkYwVEw1cndYQzJiV1ZYeUFrKysra2ZmRjFHemRqbDl5d3dtTHJJTzA4SlhrZFV3UXdBRXM2UktNdApXeGNhenV4THVzZlh3WVJDNDJJb0dRTFB6VEpEYS93VTYyd2NzY3ZDY01jazFxMk9taDI2d0xwVlZsQTV3VUxwdE8wQmQxCkE2bHBZQUgzbEREUTFIK2gzcnhqNWxsZy9nbGJ0RStxTzBGSXovSWZteFppRSswcWFBSHBNNGo3SHpCZHNUNGZ6MUtzMGQKTklQSU9nS0l1d0FBQThpOWpuZjd2WTUzK3dBQUFBZHpjMmd0Y25OaEFBQUJBUURVcmJSRThRQkhTSHZ0eThZNGcvaUZ2ZQpVbElIVEs0NTkwTllONHR4Q0JzdXA3eEVlZG56Y0dJU0NmYkkyTGN2d0dSdG1lRG5oSjNDeUE0ajJBODNuZVdOS290RDdTCm9ZdFlRekxQOVJtREdmUkwxK2xMSGViQU92VHQ0SnhHMXhMOGF5NVFkc1hSTXZtdkJjTFp0WlZmSUNUNzc2Ujk4WFViTjIKT1gzTERDWXVzZzdUd2xlUjFUQkRBQVN6cEVveTFiRnhyTzdFdTZ4OWZCaEVMallpZ1pBcy9OTWtOci9CVHJiQnl4eThKdwp4eVRXclk2YUhickF1bFZXVURuQlF1bTA3UUYzVURxV2xnQWZlVU1ORFVmNkhldkdQbVdXRCtDVnUwVDZvN1FValA4aCtiCkZtSVQ3U3BvQWVremlQc2ZNRjJ4UGgvUFVxelIwMGc4ZzZBb2k3QUFBQUF3RUFBUUFBQVFBdmlkaEdwTHdVTXU2SW04amwKN3hISkMwWkNBenczOGFNOXZZeHltakRWWE9HdTRwUERkc2c4MVlET1FkeHR0RGtEU2lqd2ZIbUV3UE10cCtScGc0TFZJWApPTkJDVWF2Y05BNmx4Y1FZUC9XdmpSVHlTMWhxeUNnV3NvRk5HNXYrOWRmck91aHEzMjhmYi9tVUVSbXRZVm1rREtFNm5vCkFPWFZQSTlGYmE0UTlOVWFJVkJzb3EwTms3aXFlVDY5Wk9LdFM2OHJsK0VBQ2RSTWF4SjU3M0loK2YzL2dBV01LUlltWGQKZ2VJSDQ2NDdlM0FseHhIYmJjNTJnWHltVGlvdjVtTG44dUNscU9CaTdjUUkzUXlKa0RiQlQ4NndHbGtkNG5pQjZWMzV0RgpjVFFNYnpyVmZ6YUFCL1czaHpGR2NjMUpTNGhaOXllQ1gwdkdUYVdVRjErSkFBQUFnUUN2TEU2MkZEODVXemxnQVVZSWttCnAreWw2S3RSNUI0c3pVV1JsNURkSjFCdm5yaVpFSGwxN1NwcVdpcVZRNFVUbFkxRFlSaHQ0NHBoUm1yK1Z2K0lwSHdRa3UKUU0rNXB2THZhTSsxV0lzRGVPNjNpNllBUnBUVkVSZjN4MVVGbWZDN2xKQ09pWVNHT0ViblE2djBDL3dEK0pMQTlXU0V2NQpsQWRCZnZQMUV4TWdBQUFJRUE2OVBrRStxRHpyZVcwU0xyZlNNNGtmeHlpUHh6eXdzMFk0MXo0RjhiME83dklwVVJNaVFzCjhRV2xyN05LOUJ4cjZpS1NNU0RLTlF1SXFCeElyaExFa3ZsTThuSEx0eWlQRkI0RmdVdXdidytzV1JIN1ByTTB6NnVoSkgKQ0JLNEN4ckxDTk1YTXcxNVFSVytHcFM4eFYwMDkxbk5HNUV3V1ZoTmhGNGpFUFBtY0FBQUNCQU9iZTViVDZ5VDB5Y0JNMQpvSlpGWjcxYlIvNUZWa0h6TExFSUZzUG9kclkwN1ZGeVFLNFYrYUtzMG40d3pnSEZYemg5S1l3a2xaa1BXSTlYQjh2RG15CnhEbjBRVjVvR1NIbVRGbThaWWN3LzJyTVh4VGY2UFZMTjNLUWdnVlpQQzF4NkwvOVQwZmx1TWpQZW1NRGNUWVJkMldmanEKZmRkMVpncnY5S1NYNjBhTkFBQUFFSE5zWlhOQVkyRmhjM0F0WVdSdGFXNEJBZz09Ci0tLS0tRU5EIE9QRU5TU0ggUFJJVkFURSBLRVktLS0tLQo=
  - path: /home/sles/.ssh/id_rsa.pub
    encoding: b64
    permissions: "0600"
    content: c3NoLXJzYSBBQUFBQjNOemFDMXljMkVBQUFBREFRQUJBQUFCQVFEVXJiUkU4UUJIU0h2dHk4WTRnL2lGdmVVbElIVEs0NTkwTllONHR4Q0JzdXA3eEVlZG56Y0dJU0NmYkkyTGN2d0dSdG1lRG5oSjNDeUE0ajJBODNuZVdOS290RDdTb1l0WVF6TFA5Um1ER2ZSTDErbExIZWJBT3ZUdDRKeEcxeEw4YXk1UWRzWFJNdm12QmNMWnRaVmZJQ1Q3NzZSOThYVWJOMk9YM0xEQ1l1c2c3VHdsZVIxVEJEQUFTenBFb3kxYkZ4ck83RXU2eDlmQmhFTGpZaWdaQXMvTk1rTnIvQlRyYkJ5eHk4Snd4eVRXclk2YUhickF1bFZXVURuQlF1bTA3UUYzVURxV2xnQWZlVU1ORFVmNkhldkdQbVdXRCtDVnUwVDZvN1FValA4aCtiRm1JVDdTcG9BZWt6aVBzZk1GMnhQaC9QVXF6UjAwZzhnNkFvaTcgc2xlc0BjYWFzcC1hZG1pbgo=
  - path: /tmp/deploy_caasp.sh
    encoding: b64
    permissions: "0744"
    content: IyEvYmluL2Jhc2gKCiMjIyMgU2NyaXB0IGlzIGJhc2VkIG9uIHVzaW5nIGEgY2VudHJhbCBzZXQgb2YgU1NIIGtleXMgCiMjIyMgSWYgdXNpbmcgdGhpcyB3aXRoIFRlcnJhZm9ybSBkZXBsb3llZCBjbHVzdGVyIG5vZGVzLCBuZWVkIHRvIG1ha2Ugc3VyZSB0aGUKIyMjIyBrZXlzIHVzZWQgYnkgdGhlIGFkbWluIG5vZGUgYXJlIHBvcHVsYXRlZCBpbiB0aGUgY2x1c3RlciBub2Rlcycgfi8uc3NoL2F1dGhvcml6ZWRfa2V5cyBmaWxlCiMjIyMgSWYgdXNpbmcgdGhpcyB3aXRoIGEgVGVycmFmb3JtIGRlcGxveWVkIGFkbWluIG5vZGUsIG5lZWQgdG8gZm9yd2FyZCB0aGUga2V5cyB0byB0aGUgYWRtaW4gbm9kZQoKIyMgVGVzdCB0byBzZWUgaWYgYW55IGNsdXN0ZXJzIGhhdmUgYmVlbiBpbml0aWFsaXplZCBmcm9tIHRoaXMgYWRtaW4gbm9kZQplY2hvICJUaGUgZm9sbG93aW5nIGN1c3RlciBkaXJlY3RvcmllcyB3ZXJlIGZvdW5kOiIKc3VkbyBmaW5kIC8gLW5hbWUga3ViZWFkbS1qb2luLmNvbmYuZCAyPi9kZXYvbnVsbAoKIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMKIyBDaXJjdWl0IGJyZWFrZXIgZm9yIGhhbmRzLW9mZiBkZXBsb3ltZW50ICMKIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMKZXZhbCAkKHNzaC1hZ2VudCkKc3NoLWFkZCB+Ly5zc2gvaWRfcnNhCgojIyBUZXN0IHRvIGVuc3VyZSBTU0gga2V5cyBhcmUgYXZhaWxhYmxlIHRvIGZvcm0gdGhlIGNsdXN0ZXIKaWYgISBzc2gtYWRkIC1sIAoJdGhlbiAKCWVjaG8gIlNTSCBmb3J3YXJkZWQga2V5cyBhcmUgbm90IGF2YWlsYWJsZS4iCglyZWFkIC1uMSAtcCAiSXMgdGhpcyBob3N0IHByb3ZpZGluZyB0aGUgY2x1c3RlciBTU0gga2V5cz8gKHkvbikiIEtFWV9IT1NUCgljYXNlICRLRVlfSE9TVCBpbgoJCXkpCgkJZWNobyAiKFJlKXN0YXJ0aW5nIHNzaC1hZ2VudCIKCQlraWxsICR7U1NIX0FHRU5UX1BJRH0KCQlldmFsICIkKHNzaC1hZ2VudCkiCgkJc3NoLWFkZAoJCTs7CgkJKikKCQllY2hvICJFbnN1cmUgdGhlIGhvc3QgcHJvdmlkaW5nIHRoZSBjbHVzdGVyIFNTSCBrZXlzIGhhcyBhIHZhbGlkIHNzaC1hZ2VudCBydW5uaW5nIAoJCShoaW50OiB0cnkga2lsbGluZyBhbnkgcnVubmluZyBzc2gtYWdlbnQncyB0aGVuIHN0YXJ0IGEgbmV3IG9uZSBhbmQgc3NoLWFkZCB0aGUgY2x1c3RlciBrZXlzKS4KCQlFeGl0aW5nIGR1ZSB0byBsYWNrIG9mIGNsdXN0ZXIgU1NIIGtleXMuIgoJCWV4aXQKCQk7OwoJZXNhYwkKIwllbHNlCiMJcmVhZCAtbjEgLXAgIklzIGF0IGxlYXN0IG9uZSBvZiB0aGUga2V5cyBzaG93biBhYm92ZSB0aGUgb25lcyBuZWVkZWQgdG8gZm9ybSB0aGUgY2x1c3Rlcj8gKHkvbikiIEtFWVMgCiMJY2FzZSAkS0VZUyBpbgojCQl5KQojCQllY2hvICJDb250aW51aW5nIHRvIG5leHQgc3RlcCBpbiBmb3JtaW5nIHRoZSBjbHVzdGVyIgojCQk7OwojCQkqKQojCQllY2hvICJFeGl0aW5nIGR1ZSB0byBsYWNrIG9mIGNsdXN0ZXIgU1NIIGtleXMuIgojCQlleGl0CiMJCTs7CiMJZXNhYwkKZmkKCgojIyBQb3B1bGF0ZXMgdGhlIGtub3duX2hvc3RzIGZpbGUgd2l0aCB0aGUgRlFETiBvZiB0aGUgY2x1c3RlciBub2RlcwojIyMgVG8gc3NoIHdpdGggYW4gYWxpYXMgb3Igc2hvcnQgbmFtZSwgY3JlYXRlIGEgLnNzaC9jb25maWcgZW50cnkgZm9yIAojIyMgZWFjaCBub2RlIHdoZXJlIEhPU1QgcG9pbnRzIHRvIHRoZSBhbGlhcyBhbmQgSE9TVE5BTUUgcG9pbnRzIHRvIHRoZSBGUUROCnNzaC1rZXlzY2FuIC1IIC1mIH4vLmFsbF9ub2RlcyA+IH4vLnNzaC9rbm93bl9ob3N0cwoKCiMjIEluaXRpYWxpemUgYSBuZXcgY2x1c3RlcgojIyMgU2V0IEFQSV9FTkRQT0lOVCB0byB0aGUgRlFETiBvZiB0aGUgbG9hZCBiYWxhbmNlciBWSVAgb3Igb2YgdGhlIG1hc3RlciBpbiBjYXNlIG9mIGEgc2luZ2xlIG1hc3RlciBkZXBsb3ltZW50CkFQSV9FTkRQT0lOVD1tYXN0ZXItMC5jYWFzcC1zdXNlY29uLmxhYgpDTFVTVEVSX05BTUU9c3VzZWNvbgoKY2Qgfjsgc2t1YmEgY2x1c3RlciBpbml0IC0tY29udHJvbC1wbGFuZSAkQVBJX0VORFBPSU5UICRDTFVTVEVSX05BTUUKY2QgJENMVVNURVJfTkFNRQoKCiMjIEJvb3RzdHJhcCB0aGUgY2x1c3RlciB3aXRoIHRoZSBmaXJzdCBtYXN0ZXIgbm9kZSBsaXN0ZWQgaW4gfi8uYWxsX25vZGVzCk1BU1RFUl9GUUROPSQoZ3JlcCBtYXN0ZXIgfi8uYWxsX25vZGVzIHwgaGVhZCAtMSkKTUFTVEVSPSQoZWNobyAkTUFTVEVSX0ZRRE4gfCBhd2sgLUYuICd7cHJpbnQkMX0nKQoKc2t1YmEgbm9kZSBib290c3RyYXAgLS11c2VyIHNsZXMgLS1zdWRvIC0tdGFyZ2V0ICR7TUFTVEVSX0ZRRE59ICR7TUFTVEVSfQoKIyMgSm9pbiB0aGUgcmVtYWluaW5nIG1hc3RlciBub2RlcyB0byB0aGUgY2x1c3RlcgojIyMgV2lsbCBzaW1wbHkgYnlwYXNzIGluIHRoZSBjYXNlIG9mIGEgc2luZ2xlIG1hc3RlciBkZXBsb3ltZW50CmZvciBNQVNURVJfRlFETiBpbiBgZ3JlcCBtYXN0ZXIgfi8uYWxsX25vZGVzIHwgdGFpbCAtbisyYDsgZG8gXApNQVNURVI9YGVjaG8gJE1BU1RFUl9GUUROIHwgYXdrIC1GLiAne3ByaW50JDF9J2A7IFwKc2t1YmEgbm9kZSBqb2luIC0tcm9sZSBtYXN0ZXIgLS11c2VyIHNsZXMgLS1zdWRvIFwKLS10YXJnZXQgJE1BU1RFUl9GUUROICRNQVNURVI7IFwKZG9uZQoKIyMgSm9pbiB0aGUgd29ya2VyIG5vZGVzIHRvIHRoZSBjbHVzdGVyCmZvciBXT1JLRVJfRlFETiBpbiBgZ3JlcCB3b3JrZXIgfi8uYWxsX25vZGVzYDsgZG8gXApXT1JLRVI9YGVjaG8gJFdPUktFUl9GUUROIHwgYXdrIC1GLiAne3ByaW50JDF9J2A7IFwKc2t1YmEgbm9kZSBqb2luIC0tcm9sZSB3b3JrZXIgLS11c2VyIHNsZXMgLS1zdWRvIFwKLS10YXJnZXQgJFdPUktFUl9GUUROICRXT1JLRVI7IFwKZG9uZQoKCiMjIEtpbGwgc3NoLWFnZW50CmtpbGwgJHtTU0hfQUdFTlRfUElEfQoKCgplY2hvIGV4cG9ydCBLVUJFQ09ORklHPSR7SE9NRX0vJHtDTFVTVEVSX05BTUV9L2FkbWluLmNvbmYgPj4gfi8uYmFzaHJjCiNjYXQ8PEVPRj4+IH4vLmJhc2hyYwojc2V0IC1vIHZpCiNhbGlhcyBrZ249Imt1YmVjdGwgZ2V0IG5vZGVzIC1vIHdpZGUiCiNhbGlhcyBrZ2Q9Imt1YmVjdGwgZ2V0IGRlcGxveW1lbnRzIC1vIHdpZGUiCiNhbGlhcyBrZ3A9Imt1YmVjdGwgZ2V0IHBvZHMgLW8gd2lkZSIKI2FsaWFzIGtncGE9Imt1YmVjdGwgZ2V0IHBvZHMgLW8gd2lkZSAtLWFsbC1uYW1lc3BhY2VzIgojYWxpYXMga2FmPSJrdWJlY3RsIGFwcGx5IC1mIgojRU9GCgouIH4vLmJhc2hyYwpjZCAke0hPTUV9LyR7Q0xVU1RFUl9OQU1FfTsgc2t1YmEgY2x1c3RlciBzdGF0dXMKa3ViZWN0bCBnZXQgbm9kZXMgLW8gd2lkZQoKCgo=
  - path: /home/sles/.bashrc
    encoding: b64
    permissions: "0644"
    content: c2V0IC1vIHZpCmFsaWFzIGtnbj0ia3ViZWN0bCBnZXQgbm9kZXMgLW8gd2lkZSIKYWxpYXMga2dkPSJrdWJlY3RsIGdldCBkZXBsb3ltZW50cyAtbyB3aWRlIgphbGlhcyBrZ3A9Imt1YmVjdGwgZ2V0IHBvZHMgLW8gd2lkZSIKYWxpYXMga2dwYT0ia3ViZWN0bCBnZXQgcG9kcyAtbyB3aWRlIC0tYWxsLW5hbWVzcGFjZXMiCmFsaWFzIGthZj0ia3ViZWN0bCBhcHBseSAtZiIK

runcmd:
  # Since we are currently inside of the cloud-init systemd unit, trying to
  # start another service by either `enable --now` or `start` will create a
  # deadlock. Instead, we have to use the `--no-block-` flag.
  - [ systemctl, enable, --now, --no-block, haproxy ]
${register_scc}
#  - [ SUSEConnect, -p, caasp/4.0/x86_64, -r, INTERNAL-USE-ONLY-e62a127779ce75cc ]
#  - [ zypper, in, --force-resolution, --no-confirm, --force, podman, kernel-default, cri-o, kubernetes-kubeadm,  kubernetes-client, skuba-update ]
#  - [ reboot ]
  - SUSEConnect --url http://rmt.suse.hpc.local
  - SUSEConnect -p sle-module-containers/15.1/x86_64
  - SUSEConnect -p caasp/4.0/x86_64 --url http://rmt.suse.hpc.local
#  - zypper --non-interactive install -t pattern SUSE-CaaSP-Management
#  - zypper --non-interactive update
  - chown -R sles:users /home/sles
#  - sleep 180
#  - sudo -H -u sles bash /tmp/deploy_caasp.sh
#  - sleep 120
#  - reboot

bootcmd:
  - ip link set dev eth0 mtu 1400

final_message: "The system is finally up, after $UPTIME seconds"
